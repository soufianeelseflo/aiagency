<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius AI Sales System - Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background-color: #1e1e1e; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        h1, h2 { color: #00ccff; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: #2a2a2a; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
        .card h3 { margin-top: 0; color: #bb86fc; font-size: 1.1em; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .card p { margin: 5px 0; font-size: 1.2em; font-weight: bold; color: #03dac6; }
        .card span { font-size: 0.9em; color: #aaa; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-running { background-color: #00e676; }
        .status-stopped { background-color: #ff1744; }
        .status-error { background-color: #ffea00; }
        .status-idle { background-color: #607d8b; }
        .status-working { background-color: #29b6f6; }
        .status-planning { background-color: #ab47bc; }
        .status-learning { background-color: #ffa726; }
        .status-unavailable { background-color: #ff1744; }
        .status-available { background-color: #00e676; }
        button { padding: 10px 20px; font-size: 1em; background-color: #00ccff; border: none; border-radius: 5px; color: #fff; cursor: pointer; transition: background-color 0.3s; margin: 5px; }
        button:hover { background-color: #0099cc; }
        #approval-status { font-weight: bold; text-align: center; margin-bottom: 20px; padding: 10px; border-radius: 4px; }
        .approved { background-color: #2e7d32; color: #c8e6c9; }
        .not-approved { background-color: #c62828; color: #ffcdd2; }
        pre { background-color: #2a2a2a; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.9em; }
        .grafana-placeholder { border: 1px dashed #555; padding: 20px; text-align: center; color: #888; margin-top: 20px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Genius AI Sales System Dashboard</h1>

        <div id="approval-status">Loading Approval Status...</div>

        <div class="control-panel" style="text-align: center; margin-bottom: 20px;">
            <button id="approve-button" onclick="approveAgency()" style="display: none;">Approve Agency Operation</button>
            <!-- Add other control buttons if needed -->
            <button onclick="downloadData()">Download DB (Requires Password)</button>
        </div>

        <h2>Key Performance Indicators (KPIs) - Last 24 Hours</h2>
        <div class="grid">
            <div class="card">
                <h3>Total Profit (All Time)</h3>
                <p id="kpi-total-profit">$0.00</p>
                <span>Based on paid invoices</span>
            </div>
            <div class="card">
                <h3>Emails Sent (24h)</h3>
                <p id="kpi-emails-sent">0</p>
                <span>Total attempts</span>
            </div>
            <div class="card">
                <h3>Emails Opened (24h)</h3>
                <p id="kpi-emails-opened">0</p>
                <span id="kpi-open-rate">Rate: 0.0%</span>
            </div>
            <div class="card">
                <h3>Emails Responded (24h)</h3>
                <p id="kpi-emails-responded">0</p>
                <span id="kpi-response-rate">Rate: 0.0%</span>
            </div>
            <div class="card">
                <h3>Calls Made (24h)</h3>
                <p id="kpi-calls-made">0</p>
                <span>Total outbound initiated</span>
            </div>
            <div class="card">
                <h3>Calls Successful (24h)</h3>
                <p id="kpi-calls-success">0</p>
                <span id="kpi-call-success-rate">Rate: 0.0%</span>
            </div>
             <div class="card">
                <h3>Avg. Client Score</h3>
                <p id="kpi-avg-score">0.0</p>
                <span>Across active clients</span>
            </div>
             <div class="card">
                <h3>Active Clients</h3>
                <p id="kpi-active-clients">0</p>
                <span>Opted-in clients</span>
            </div>
        </div>

        <h2>System Status</h2>
        <div class="grid">
            <div class="card">
                <h3>Orchestrator</h3>
                <p id="status-orchestrator"><span class="status-indicator status-stopped"></span>Stopped</p>
            </div>
            <div class="card">
                <h3>LLM Clients</h3>
                <div id="status-llm">Loading...</div>
            </div>
        </div>

        <h2>Agent Status</h2>
        <div class="grid" id="agent-status-grid">
            <!-- Agent statuses will be loaded here -->
            <p>Loading agent statuses...</p>
        </div>

        <!-- Placeholder for Grafana Dashboard -->
        <h2>Detailed Monitoring (Grafana)</h2>
        <div class="grafana-placeholder">
            Grafana iframe placeholder. Configure your Grafana dashboard in Coolify and embed the panel URL here using an iframe tag. Example:<br>
            <code><iframe src="YOUR_GRAFANA_PANEL_URL" width="100%" height="400" frameborder="0"></iframe></code>
        </div>

    </div>

    <script>
        const approvalStatusDiv = document.getElementById('approval-status');
        const approveButton = document.getElementById('approve-button');
        const kpiElements = {
            total_profit: document.getElementById('kpi-total-profit'),
            emails_sent_24h: document.getElementById('kpi-emails-sent'),
            emails_opened_24h: document.getElementById('kpi-emails-opened'),
            open_rate: document.getElementById('kpi-open-rate'),
            emails_responded_24h: document.getElementById('kpi-emails-responded'),
            response_rate: document.getElementById('kpi-response-rate'),
            calls_made_24h: document.getElementById('kpi-calls-made'),
            calls_success_24h: document.getElementById('kpi-calls-success'),
            call_success_rate: document.getElementById('kpi-call-success-rate'),
            avg_client_score: document.getElementById('kpi-avg-score'),
            active_clients: document.getElementById('kpi-active-clients')
        };
        const statusOrchestrator = document.getElementById('status-orchestrator');
        const statusLlm = document.getElementById('status-llm');
        const agentStatusGrid = document.getElementById('agent-status-grid');

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status_kpi');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update Approval Status
                if (data.approved_for_operation) {
                    approvalStatusDiv.textContent = 'Agency Operation: APPROVED';
                    approvalStatusDiv.className = 'approved';
                    approveButton.style.display = 'none';
                } else {
                    approvalStatusDiv.textContent = 'Agency Operation: NOT APPROVED (Requires API call to /api/approve)';
                    approvalStatusDiv.className = 'not-approved';
                    approveButton.style.display = 'inline-block';
                }

                // Update KPIs
                const kpis = data.kpis || {};
                kpiElements.total_profit.textContent = `$${kpis.total_profit?.toFixed(2) || '0.00'}`;
                kpiElements.emails_sent_24h.textContent = kpis.emails_sent_24h || 0;
                kpiElements.emails_opened_24h.textContent = kpis.emails_opened_24h || 0;
                kpiElements.emails_responded_24h.textContent = kpis.emails_responded_24h || 0;
                kpiElements.calls_made_24h.textContent = kpis.calls_made_24h || 0;
                kpiElements.calls_success_24h.textContent = kpis.calls_success_24h || 0;
                kpiElements.avg_client_score.textContent = kpis.avg_client_score?.toFixed(3) || '0.0';
                kpiElements.active_clients.textContent = kpis.active_clients || 0;

                // Calculate Rates
                const openRate = kpis.emails_sent_24h > 0 ? ((kpis.emails_opened_24h || 0) / kpis.emails_sent_24h * 100).toFixed(1) : 0;
                const responseRate = kpis.emails_sent_24h > 0 ? ((kpis.emails_responded_24h || 0) / kpis.emails_sent_24h * 100).toFixed(1) : 0;
                const callSuccessRate = kpis.calls_made_24h > 0 ? ((kpis.calls_success_24h || 0) / kpis.calls_made_24h * 100).toFixed(1) : 0;
                kpiElements.open_rate.textContent = `Open Rate: ${openRate}%`;
                kpiElements.response_rate.textContent = `Response Rate: ${responseRate}%`;
                kpiElements.call_success_rate.textContent = `Success Rate: ${callSuccessRate}%`;


                // Update Orchestrator Status
                const orchStatus = data.orchestrator_status || 'unknown';
                statusOrchestrator.innerHTML = `<span class="status-indicator status-${orchStatus}"></span>${orchStatus.charAt(0).toUpperCase() + orchStatus.slice(1)}`;
                statusOrchestrator.className = ''; // Clear previous classes
                statusOrchestrator.classList.add(`status-${orchStatus}`);


                // Update LLM Status
                const llmStatuses = data.llm_client_status || {};
                let llmHtml = '';
                if (Object.keys(llmStatuses).length > 0) {
                    for (const [keyId, status] of Object.entries(llmStatuses)) {
                        llmHtml += `<p><span class="status-indicator status-${status}"></span>Key ...${keyId}: ${status}</p>`;
                    }
                } else {
                    llmHtml = '<p>No LLM clients initialized or status unavailable.</p>';
                }
                statusLlm.innerHTML = llmHtml;

                // Update Agent Statuses
                const agentStatuses = data.agent_statuses || {};
                agentStatusGrid.innerHTML = ''; // Clear previous statuses
                if (Object.keys(agentStatuses).length > 0) {
                    for (const [agentName, statusInfo] of Object.entries(agentStatuses)) {
                        const status = statusInfo.status || 'unknown';
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <h3>${agentName}</h3>
                            <p><span class="status-indicator status-${status}"></span>${status.charAt(0).toUpperCase() + status.slice(1)}</p>
                            <span>Queue: ${statusInfo.queue_size ?? 'N/A'} | Tasks: ${statusInfo.tasks_processed_session ?? 0} | Errors: ${statusInfo.errors_encountered_session ?? 0}</span>
                        `;
                        agentStatusGrid.appendChild(card);
                    }
                } else {
                    agentStatusGrid.innerHTML = '<p>No agent statuses available.</p>';
                }

            } catch (error) {
                console.error('Error fetching status:', error);
                approvalStatusDiv.textContent = 'Error fetching status.';
                approvalStatusDiv.className = 'not-approved'; // Use error styling
            }
        }

        async function approveAgency() {
            if (!confirm('Are you sure you want to approve the agency for full operation?')) return;
            try {
                const response = await fetch('/api/approve_agency', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'approved') {
                    alert('Agency approved!');
                    fetchStatus(); // Refresh status display
                } else {
                    alert(`Approval failed: ${data.error || 'Unknown error'}`);
                }
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }

        async function downloadData() {
            const password = prompt("Enter password to download data:");
            if (!password) return;
            try {
                const response = await fetch('/api/download_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // Use a generic name as direct DB download isn't ideal for Postgres
                    a.download = 'agency_export_data.json'; // Suggest JSON export instead
                    alert("Note: Direct DB download isn't supported for Postgres. This endpoint should ideally trigger a data export (e.g., JSON/CSV). Placeholder download initiated.");
                    // document.body.appendChild(a);
                    // a.click();
                    // window.URL.revokeObjectURL(url);
                    // document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert(`Download failed: ${data.error || response.statusText}`);
                }
            } catch (e) {
                alert(`Error: ${e.message}`);
            }
        }

        // Fetch status immediately and then every 10 seconds
        fetchStatus();
        setInterval(fetchStatus, 10000); // Refresh every 10 seconds
    </script>
</body>
</html>