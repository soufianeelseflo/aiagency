# Filename: nixpacks.toml
# Description: Configuration for the Nixpacks build process.
# Version: 1.1 (Corrected duplicate 'cmds' key under [phases.install])

[phases.setup]
# Add required system packages using apt for the Ubuntu-based builder
aptPkgs = [
    # Base build tools (already likely included by Nixpacks, but explicit doesn't hurt)
    "build-essential", "curl", "wget", "git",
    # Postgres client dev files (needed for psycopg2/asyncpg build)
    "libpq-dev",
    # Reportlab dependencies (for Pillow/XML/Font support)
    "libjpeg-dev", "zlib1g-dev", "libfreetype6-dev", "libxml2-dev", "libxslt1-dev",
    # Playwright required system dependencies (copy from Dockerfile RUN command)
    "libnss3", "libatk-bridge2.0-0", "libxkbcommon0", "libgbm1", "libasound2", "libatk1.0-0",
    "libcairo2", "libcups2", "libdbus-1-3", "libexpat1", "libfontconfig1", "libgcc1",
    "libgconf-2-4", "libgdk-pixbuf2.0-0", "libglib2.0-0", "libgtk-3-0", "libnspr4",
    "libpango-1.0-0", "libpangocairo-1.0-0", "libstdc++6", "libx11-6", "libx11-xcb1",
    "libxcb1", "libxcomposite1", "libxcursor1", "libxdamage1", "libxext6", "libxfixes3",
    "libxi6", "libxrandr2", "libxrender1", "libxss1", "libxtst6", "ca-certificates",
    "fonts-liberation", "libappindicator1", "lsb-release", "xdg-utils"
]

[phases.install]
# Install python packages using pip from requirements.txt AND install playwright browsers
# CORRECTED: Use a single 'cmds' array with multiple command strings
cmds = [
    "python -m venv --copies /opt/venv && . /opt/venv/bin/activate && pip install --no-cache-dir --upgrade pip && pip install --no-cache-dir -r requirements.txt",
    ". /opt/venv/bin/activate && python -m playwright install --with-deps chromium" # Run playwright install within the venv
]
cacheDirectories = ["/root/.cache/pip", "/root/.cache/ms-playwright"] # Cache playwright downloads too
paths = ["/opt/venv/bin"] # Ensure venv bin is in PATH

[start]
# Default start command (Using Quart's built-in server)
cmd = "quart run --host 0.0.0.0 --port $PORT" # Use $PORT env var